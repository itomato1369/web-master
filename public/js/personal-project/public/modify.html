<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 사연 조회 및 수정</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>📝 사연 조회 및 수정</h1>
            <p class="subtitle">이전에 제출하신 사연 내용을 확인하고 수정할 수 있습니다.</p>
        </header>

        <div class="info-alert">
            <p>사연자가 입력한 정보들을 불러왔습니다.<br>
                수정할 내용이 없으시면 페이지를 닫거나 돌아가셔도 됩니다<i class="fa-solid fa-backward"></i>
            </p>
        </div>

        <form action="/update-story" method="post" class="story-form" id="story_update_form">
            <input type="hidden" id="story_id_hidden" name="story_id" value="">
            <input type="hidden" id="lookup_pw_hidden" name="lookup_pw" value="">

            <section class="section essential-info">
                <h2><i class="fa-solid fa-user"></i> 사연 응모자 정보 (수정)</h2>

                    <div class="form-group">
                        <label for="story_name">이름/닉네임</label>
                        <input type="text" id="story_name" name="story_name" value="">
                    </div>

                    <div class="form-group inline-unit">
                        <label for="story_age">나이</label>
                        <input type="number" id="story_age" name="story_age"> <label class="unit-label">세</label>
                    </div>

                    <div class="form-group">
                        <label>성별</label>
                        <div class="radio-group">
                            <div>
                                <input type="radio" id="gender_m" name="story_gender" value="남성">
                                <label for="gender_m">남성</label>
                            </div>
                            <div>
                                <input type="radio" id="gender_f" name="story_gender" value="여성">
                                <label for="gender_f">여성</label>
                            </div>
                            <div>
                                <input type="radio" id="gender_etc" name="story_gender" value="기타">
                                <label for="gender_etc">기타</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="gender_other_input" style="display: none; margin-top: 15px;">
                        <label for="story_gender_other">직접입력</label>
                        <input type="text" id="story_gender_other" name="story_gender_other" placeholder="직접입력" value="">
                    </div>

                    <div class="form-group">
                        <label for="story_pw">사연 비밀번호 변경 / 변경을 원치 않을 시 비워두세요</label>
                        <input type="password" id="story_pw" name="story_pw" minlength="4"
                        placeholder="4자리 이상, 숫자, 영어 대/소문자 및 특수문자 포함">
                    </div>
            </section>

            <section class="section story-content-area">
                <h2><i class="fa-solid fa-pen"></i> 입력한 사연 내용</h2>
                    <div class="form-group">
                        <label for="story_content">사연 조회 및 수정</label>
                        <textarea id="story_content" name="story_content" rows="10"></textarea>
                    </div>
            </section>

            <section class="section prize-info-area">
                <h2><i class="fa-solid fa-gift"></i> 경품응모 수정</h2>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="gift_apply" name="gift_apply" value="Y">
                        <label for="gift_apply">경품 응모에 참여합니다</label>
                    </div>
            </section>

            <section class="section prize-info" id="prize-info-section" style="display: none;">
                <h2>경품 수령 정보</h2>
                    <div class="form-group">
                        <label for="applicant_name">수령인 이름</label>
                        <input type="text" id="applicant_name" name="applicant_name" placeholder="본명">
                    </div>

                    <div class="form-group">
                        <label for="applicant_email">이메일</label>
                        <input type="email" id="applicant_email" name="applicant_email" placeholder="경품 당첨 안내 이메일">
                    </div>

                    <div class="form-group">
                        <label for="applicant_phone">연락처</label>
                        <input type="tel" id="applicant_phone" name="applicant_phone" placeholder="010-1234-5678">
                    </div>

                    <div class="form-group">
                        <label for="applicant_postal">경품 수령할 주소/우편번호</label>
                            <div class="address-group">
                                <div class="post-search-line">
                                    <input type="text" id="applicant_postal" name="applicant_postal" placeholder="00000"
                                    maxlength="5" readonly> <input type="button" onclick="searchAddress()" value="우편번호 찾기"
                                    class="postcode-btn">
                                </div>
                                <input type="text" id="address" placeholder="주소" readonly>
                            </div>
                    </div>

                    <div class="form-group">
                        <label for="address_detail">상세 주소</label>
                        <input type="text" id="address_detail" name="address_detail" placeholder="아파트 동/호수, 건물 이름 등">
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="privacy_agree" name="privacy_agree" value="Y">
                        <label for="privacy_agree">경품 발송을 위한 개인정보 수집 및 이용에 동의합니다.</label>
                    </div>
            </section>

            <div class="submit-area">
                <button type="submit" class="submit-button">사연 수정하기</button>
            </div>
        </form>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="/terms_of_service.html">이용약관</a>
                <a href="/privacy_policy.html">개인정보처리방침</a>
                <a href="/about_us.html">회사 소개</a>
                <a href="/contact.html">문의하기</a>
            </div>

            <div class="social-media">
                <p>라디오 소식을 SNS에서도 만나보세요!</p>
                <div class="social-icons">
                    <a href="https://www.instagram.com/" target="instagram" title="인스타그램">
                        <i class="fab fa-instagram"></i></a>

                    <a href="https://www.youtube.com/" target="youtube" title="유튜브">
                        <i class="fab fa-youtube"></i></a>

                    <a href="https://x.com/i/flow/login" target="x" title="엑스">
                        <i class="fa-brands fa-x-twitter"></i></a>
                </div>
            </div>

            <div class="copyright">
                <p>라디오 사연 모집 이벤트</p>
                <p>&copy; 2025 RADIO EVENT FM. All Rights Reserved.
            </div>
        </div>
    </footer>

    <script>
        // 카카오(다음) 주소 API 함수를 정의합니다.
        function searchAddress() {
            new daum.Postcode({
                // 주소 검색 팝업 객체를 만든다
                oncomplete: function (data) {
                    // 콜백 함수(Callback Function)
                    // 주소 검색 팝업에서 항목을 선택했을 때 실행될 코드입니다.
                    // 주소 정보는 data 라는 변수에 담겨 함수로 전달

                    var addr = ''; // 주소를 저장할 빈 문자열 addr 선언
                    var extraAddr = ''; // 참고항목을 저장할 빈 문자열 extraAddr 선언

                    // (1) 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져옵니다.
                    if (data.userSelectedType === 'R') {
                        // 도로명 주소 선택 시 'R'
                        addr = data.roadAddress;
                    } else {
                        // 지번 주소 선택 시 'J'
                        addr = data.jibunAddress;
                    }

                    // (2) 건물명이 있고, 아파트/빌라 등 공동주택인 경우 참고항목에 추가합니다.
                    if (data.userSelectedType === 'R') {
                        // 도로명 주소를 선택했을 때만
                        // 법정동명이 있을 경우
                        if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                            extraAddr += data.bname;
                        }
                        // 건물명 추가
                        if (data.buildingName !== '' && data.apartment === 'Y') {
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        // 표시할 참고항목이 있을 경우 괄호로 묶어 최종 주소 뒤에 추가합니다.
                        if (extraAddr !== '') {
                            addr += ' (' + extraAddr + ')';
                        }
                    }

                    // (3) 우편번호와 주소 정보를 해당 필드에 넣고, 상세주소 필드로 포커스를 이동시킵니다.
                    document.getElementById('applicant_postal').value = data.zonecode; // 우편번호
                    document.getElementById("address").value = addr; // 주소
                    document.getElementById("address_detail").focus(); // 상세 주소 필드로 포커스 이동
                    // 참고: 상세 주소는 사용자가 직접 입력해야 합니다.
                }
            }).open();
            // 주소 검색 팝업 창을 화면에 띄우는 명령
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 폼 요소 변수 초기화
            const genderEtcRadio = document.getElementById('gender_etc');
            const genderEtcInput = document.getElementById('gender_other_input');
            const genderEtcField = document.getElementById('story_gender_other');
            const genderRadios = document.querySelectorAll('input[name="story_gender"]');
            const giftApplyCheckbox = document.getElementById('gift_apply');
            const prizeInfoSection = document.getElementById('prize-info-section');
            const lookupPwHidden = document.getElementById('lookup_pw_hidden');
            const storyIdHidden = document.getElementById('story_id_hidden'); // 🌟 사연 ID 필드

            // 헬퍼 함수 1: '기타' 성별 입력 필드 토글 
            function toggleGenderOtherInput() {
                if (genderEtcRadio.checked) {
                    genderEtcInput.style.display = 'block';
                    genderEtcField.setAttribute('required', 'required');
                } else {
                    genderEtcInput.style.display = 'none';
                    genderEtcField.removeAttribute('required');
                }
            }

            // 헬퍼 함수 2: 경품 응모 정보 섹션 토글 
            function togglePrizeInfoSection() {
                if (giftApplyCheckbox.checked) {
                    prizeInfoSection.style.display = 'block';
                } else {
                    prizeInfoSection.style.display = 'none';
                }
            }


            // 1. URL에서 이름과 비밀번호를 추출합니다.
            const params = new URLSearchParams(window.location.search);
            const lookupName = params.get('lookup_name');
            const lookupPw = params.get('lookup_pw');

            if (lookupPwHidden && lookupPw) {
                lookupPwHidden.value = lookupPw;
            }
            if (!lookupName || !lookupPw) {
                alert('조회 정보가 누락되었습니다. 메인페이지로 돌아갑니다');
                window.location.href = '/';
                return;
            }

            // 2. 서버에 데이터 조회를 요청합니다.
            fetch(
                    `/get-story?lookup_name=${encodeURIComponent(lookupName)}&lookup_pw=${encodeURIComponent(lookupPw)}`
                    )
                .then(response => {
                    // HTTP 상태 코드 처리
                    if (response.status === 404) {
                        alert('일치하는 사연을 찾을 수 없습니다. 이름과 비밀번호를 확인해 주세요.');
                        window.location.href = '/';
                        return null;
                    }
                    if (!response.ok) {
                        throw new Error('서버에서 데이터를 불러오는 데 실패했습니다. (응답 상태:' + response.status + ')');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;

                    // 3. 조회된 데이터를 폼 필드에 채웁니다.
                    document.getElementById('story_name').value = data.STORY_NAME || '';
                    document.getElementById('story_age').value = data.STORY_AGE || '';
                    storyIdHidden.value = data.STORY_ID || '';


                    // 🟢 성별 선택 로직
                    const gender = data.STORY_GENDER;

                    if (gender === '남성') {
                        // 실제 HTML ID: gender_m
                        document.getElementById('gender_m').checked = true;
                    } else if (gender === '여성') {
                        // 실제 HTML ID: gender_f
                        document.getElementById('gender_f').checked = true;
                    } else if (gender) {
                        // 기타, 또는 직접 입력된 값 처리
                        document.getElementById('gender_etc').checked = true; // HTML ID: gender_etc

                        // 기타 필드에 값을 채우고, 입력창을 보이게 합니다.
                        if (gender !== '기타') {
                            document.getElementById('story_gender_other').value = gender;
                        } else {
                            document.getElementById('story_gender_other').value = '';
                        }
                    }
                    // 사연 내용
                    document.getElementById('story_content').value = data.STORY_CONTENT || '';

                    // 경품 응모 정보 필드 채우기
                    const isGiftApplied = data.GIFT_APPLY === 'Y';
                    giftApplyCheckbox.checked = isGiftApplied;

                    if (isGiftApplied) {
                        document.getElementById('applicant_name').value = data.APPLICANT_NAME || '';
                        document.getElementById('applicant_email').value = data.APPLICANT_EMAIL || '';
                        document.getElementById('applicant_phone').value = data.APPLICANT_PHONE || '';
                        document.getElementById('applicant_postal').value = data.APPLICANT_POSTAL || '';
                        document.getElementById('address_detail').value = data.ADDRESS_DETAIL || '';
                        document.getElementById('privacy_agree').checked = data.PRIVACY_AGREE === 'Y';
                    }

                    // 초기 상태 반영 및 이벤트 리스너 설정
                    toggleGenderOtherInput();
                    genderRadios.forEach(radio => {
                        radio.addEventListener('change', toggleGenderOtherInput);
                    });
                    togglePrizeInfoSection();
                    giftApplyCheckbox.addEventListener('change', togglePrizeInfoSection);

                })
                .catch(error => {
                    console.error("데이터 로드 중 에러 발생:", error);
                    alert(`🚨 데이터 로드에 실패했습니다. (메시지: ${error.message})`);
                    window.location.href = '/';
                });

            const updateForm = document.getElementById('story_update_form');
            const passwordUpdateField = document.getElementById('story_pw');

            // 🚨 기존의 폼 제출 리스너를 AJAX 방식으로 교체합니다.
            updateForm.addEventListener('submit', function (event) {
                event.preventDefault(); // 폼의 기본 제출 동작(페이지 이동)을 막습니다. (가장 중요)
                //  1. 경품 응모 필수 필드 유효성 검사 로직 추가 (최우선)
                // =================================================================
                const giftApplyCheckbox = document.getElementById('gift_apply');

                if (giftApplyCheckbox.checked) {
                    // 검증할 경품 정보 필드 목록 (ID 사용)
                    const fields = [{
                            id: 'applicant_name',
                            name: '경품 수령인 이름'
                        },
                        {
                            id: 'applicant_email',
                            name: '이메일'
                        },
                        {
                            id: 'applicant_phone',
                            name: '연락처'
                        },
                        {
                            id: 'applicant_postal',
                            name: '우편번호'
                        },
                        {
                            id: 'address_detail',
                            name: '상세 주소'
                        },
                        {
                            id: 'privacy_agree',
                            name: '개인정보 동의'
                        }
                    ];

                    for (const field of fields) {
                        const element = document.getElementById(field.id);

                        // 체크박스 검증
                        if (element.type === 'checkbox' && !element.checked) {
                            alert(`🚨 경품 응모를 완료하려면 '${field.name}'에 동의해야 합니다.`);
                            element.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                            return; // 제출 중단
                        }
                        // 일반 입력 필드 검증 (비어 있거나 공백만 있는 경우)
                        else if (element.type !== 'checkbox' && element.value.trim() === '') {
                            alert(`🚨 경품 응모를 완료하려면 '${field.name}'을(를) 입력해야 합니다.`);
                            element.focus();
                            return; // 제출 중단
                        }
                    }
                }

                // 1. 비밀번호 변경 시 유효성 검사
                if (passwordUpdateField.value) {
                    const hasUpperCase = /[A-Z]+/g;
                    const hasLowerCase = /[a-z]+/g;
                    const hasSpecialChar = /[!@#$%^&*]+/g;

                    if (passwordUpdateField.value.length < 4 || !hasUpperCase.test(passwordUpdateField
                            .value) || !hasLowerCase.test(passwordUpdateField.value) || !hasSpecialChar
                        .test(passwordUpdateField.value)) {
                        alert(
                            '비밀번호 변경 시 규칙을 만족해야 합니다.\n(4자리 이상, 대문자, 소문자, 특수문자(!@#$%^&*)를 각각 1개 이상 포함)'
                            );
                        passwordUpdateField.focus();
                        return; // 유효성 검사 실패 시 함수 종료
                    }
                }

                // 2. 폼 데이터 수집 및 전송
                const formData = new FormData(updateForm);

                // fetch API를 사용하여 서버에 비동기 요청을 보냅니다.
                fetch(updateForm.action, {
                        method: 'POST', // POST 방식으로 데이터를 전송합니다.
                        // FormData를 URL-encoded 형식으로 변환하여 전송합니다.
                        body: new URLSearchParams(formData),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    })
                    .then(response => {
                        // 응답 상태가 200번대가 아니면 에러로 처리
                        if (!response.ok) {
                            // 서버가 오류 메시지를 JSON으로 보냈다면 파싱하여 에러를 던집니다.
                            return response.json().then(errorData => {
                                throw new Error(errorData.message ||
                                    '사연 수정 중 알 수 없는 오류가 발생했습니다.');
                            }).catch(() => {
                                // JSON 파싱에 실패하면 HTTP 상태 코드를 사용
                                throw new Error('사연 수정 중 서버 오류가 발생했습니다. (응답 코드: ' + response
                                    .status + ')');
                            });
                        }
                        // 성공적인 응답 (2xx)일 경우 JSON 파싱을 시도합니다.
                        // 서버가 응답으로 {"message":"사연이 성공적으로 수정되었습니다."} 를 보내므로 JSON 파싱이 필요합니다.
                        return response.json();
                    })
                    .then(data => {
                        // 3. 성공 응답 처리: alert를 띄우고 페이지를 새로고침합니다.
                        if (data.message && data.message.includes("성공적으로 수정")) {
                            alert('✅ 사연이 수정되었습니다!');
                            window.location.reload(); // 수정된 내용을 반영하기 위해 페이지 새로고침
                        } else {
                            // 서버에서 예상치 못한 성공 응답이 올 경우
                            alert('✅ 사연 수정은 완료되었으나, 응답 메시지가 예상과 다릅니다. 페이지를 새로고침합니다.');
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        // 4. 실패 응답 처리
                        console.error('사연 수정 실패:', error);
                        alert(`🚨 사연 수정에 실패했습니다: ${error.message}`);
                    });
            });
        }); // <-- DOMContentLoaded 이벤트 리스너가 닫힙니다.
    </script>

</body>

</html>