<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 사연 조회 및 수정</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fa-solid fa-list-check"></i>  사연 조회 및 수정</h1>
            <p class="subtitle">이전에 제출하신 사연 내용을 확인하고 수정할 수 있습니다.</p>
        </header>

        <div class="info-alert">
            <p>
                사연자가 입력한 정보들을 불러왔습니다.<br>
                수정할 내용이 없으시면 페이지를 닫거나 돌아가셔도 됩니다<i class="fa-solid fa-backward"></i> 
            </p>
        </div>

        <form action="/update-story" method="post" class="story-form" id="story_update_form">

            <input type="hidden" name="story_id" id="story_id_hidden" value="[조회된 사연 ID]">

            <section class="section essential-info">
                <h2>사연 응모자 정보 (수정)</h2>
                <div class="form-group">
                    <label for="story_name">이름/닉네임</label>
                    <input type="text" id="story_name" name="story_name">
                </div>
                
                <div class="form-group inline-unit">
                    <label for="story_age">나이</label>
                    <input type="text" id="story_age" name="story_age"><label class="unit-label">세</label>
                </div>
                
                <div class="form-group">
                    <label>성별</label>
                    <div class="radio-group">
                        <div>
                            <input type="radio" id="gender_male" name="story_gender" value="남성">
                            <label for="gender_male">남성</label>
                        </div>

                        <div>
                            <input type="radio" id="gender_female" name="story_gender" value="여성">
                            <label for="gender_female">여성</label>
                        </div>

                        <div>
                            <input type="radio" id="gender_other_radio" name="story_gender" value="기타">
                            <label for="gender_other_radio">직접입력</label>
                        </div>
                    </div>
                        <input type="text" id="story_gender_other" name="story_gender_other" style="display:none; margin-top: 10px;" placeholder="직접 입력">
                </div>
            </section>
            
            <section class="section story-content-area">
                <h2>사연 내용 (수정)</h2>
                <div class="form-group">
                    <label for="story_content">사연을 수정해 주세요</label>
                    <textarea id="story_content" name="story_content" rows="10" placeholder="당신의 이야기를 들려주세요."></textarea>
                </div>

                <div class="form-group">
                    <label for="story_pw">새 사연 비밀번호</label>
                    <input type="password" id="story_pw" name="story_pw" placeholder="※변경할 경우에만 입력※ (4자리 이상, 영어 대/소문자, 특수문자 포함)">
                    <p class="guide-text"> ⚠️비밀번호를 변경하지 않으려면 이 곳을 비워두세요⚠️(기존 비밀번호 유지)</p>
                </div>
            </section>

            <section class="section prize-info-area">
                <h2>경품 응모 정보 (수정)</h2>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="gift_apply" name="gift_apply" value="Y">
                    <label for="gift_apply">경품 응모에 참여합니다</label>
                </div>
                
                <div id="prize_info_fields" style="display: none;">
                    <div class="form-group">
                        <label for="applicant_name">경품 수령인 이름(주민등록상 이름)</label>
                        <input type="text" id="applicant_name" name="applicant_name" placeholder="본명">
                    </div>
                    <div class="form-group">
                        <label for="applicant_email">이메일</label>
                        <input type="email" id="applicant_email" name="applicant_email" placeholder="경품 당첨 안내 이메일">
                    </div>
                    <div class="form-group">
                        <label for="applicant_phone">연락처</label>
                        <input type="tel" id="applicant_phone" name="applicant_phone" placeholder="010-1234-5678">
                    </div>
                    
                    <div class="form-group">
                    <label for="applicant_postal">경품 수령할 주소/우편번호</label>
                        <div class="address-group">
                                <div class="post-search-line">
                                <input type="text" id="applicant_postal" name="applicant_postal" placeholder="00000" maxlength="5" readonly> <input type="button" onclick="execDaumPostcode()" value="우편번호 찾기" class="postcode-btn">
                                </div>
                            <input type="text" id="address" placeholder="주소" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address_detail">상세 주소</label>
                        <input type="text" id="address_detail" name="address_detail" placeholder="아파트 동/호수, 건물 이름 등">
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="privacy_agree" name="privacy_agree" value="Y">
                        <label for="privacy_agree">경품 발송을 위한 개인정보 수집 및 이용에 동의합니다</label>
                    </div>
                </div>
            </section>

            <div class="submit-area">
                <button type="submit" class="submit-button">사연 수정하기</button>
            </div>
        </form>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="/terms_of_service.html">이용약관</a>
                <a href="/privacy_policy.html">개인정보처리방침</a>
                <a href="/about_us.html">회사 소개</a>
                <a href="/contact.html">문의하기</a>
            </div>
            
            <div class="social-media">
                <p>라디오 소식을 SNS에서 만나보세요!</p>
                <div class="social-icons">
                    <a href="https://www.instagram.com/" target="instagram" title="인스타그램">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://www.youtube.com/" target="youtube" title="유튜브">
                        <i class="fab fa-youtube"></i>
                    </a>
                    <a href="https://x.com/i/flow/login" target="x" title="엑스">
                        <i class="fa-brands fa-x-twitter"></i>
                    </a>
                </div>
            </div>

            <div class="copyright">
                <p>라디오 사연 모집 이벤트</p>
                <p>&copy; 2025 RADIO EVENT FM. All Rights Reserved. 
        </div>
    </footer>
</body>

<script>
    function execDaumPostcode() {
    new daum.Postcode({
        oncomplete: function(data) {
            // 팝업에서 검색 결과 항목을 선택했을 때 실행될 코드입니다.

            var addr = ''; // 주소 변수
            var extraAddr = ''; // 참고항목 변수

            // (1) 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져옵니다.
            if (data.userSelectedType === 'R') { // 도로명 주소 선택 시
                addr = data.roadAddress;
            } else { // 지번 주소 선택 시
                addr = data.jibunAddress;
            }

            // (2) 건물명이 있고, 아파트/빌라 등 공동주택인 경우 참고항목에 추가합니다.
            if(data.userSelectedType === 'R'){
                // 법정동명이 있을 경우
                if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                    extraAddr += data.bname;
                }
                // 건물명이 있을 경우
                if(data.buildingName !== '' && data.apartment === 'Y'){
                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                // 표시할 참고항목이 있을 경우 괄호로 묶어 최종 주소 뒤에 추가합니다.
                if(extraAddr !== ''){
                    addr += ' (' + extraAddr + ')';
                }
            }

            // (3) 우편번호와 주소 정보를 해당 필드에 넣고, 상세주소 필드로 포커스를 이동시킵니다.
            document.getElementById('applicant_postal').value = data.zonecode; // 우편번호
            document.getElementById("address").value = addr; // 주소
            document.getElementById("address_detail").focus(); // 상세 주소 필드로 포커스 이동

            // 참고: 상세 주소는 사용자가 직접 입력해야 합니다.
        }
    }).open();
}

    const urlParams = new URLSearchParams(window.location.search);
    const giftApplyCheckbox = document.getElementById('gift_apply');
    const prizeInfoSection = document.getElementById('prize_info_fields');
    
    // 성별-기타 관련 DOM 요소 (Radio 기반)
    const genderRadios = document.querySelectorAll('input[name="story_gender"]');
    const genderOtherInput = document.getElementById('story_gender_other');
    const radioMale = document.getElementById('gender_male');
    const radioFemale = document.getElementById('gender_female');
    const radioOther = document.getElementById('gender_other_radio');


    // 성별-기타 입력 필드 토글 로직 (Radio 기반)
    function toggleGenderOtherInput() {
        const selectedGender = document.querySelector('input[name="story_gender"]:checked')?.value;
        if (selectedGender === '기타') {
            genderOtherInput.style.display = 'block';
            genderOtherInput.setAttribute('required', 'required');
        } else {
            genderOtherInput.style.display = 'none';
            genderOtherInput.removeAttribute('required');
        }
    }

    // 경품 정보 섹션 토글 함수 
    function togglePrizeInfoSection() {
        const isChecked = giftApplyCheckbox.checked;
        prizeInfoSection.style.display = isChecked ? 'block' : 'none';
        
        const requiredFields = prizeInfoSection.querySelectorAll(
            '#applicant_name, #applicant_email, #applicant_phone, #applicant_postal, #address_detail, #privacy_agree'
        );
        
        requiredFields.forEach(field => {
            if (isChecked) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else if (field.value) {
                    field.value = '';
                }
            }
        });
    }

    // 서버에서 기존에 저장된 사연 데이터를 가져와 필드에 채우기
    const lookupName = urlParams.get('lookup_name');
    const lookupPw = urlParams.get('lookup_pw'); 
    
    if (!lookupName || !lookupPw) {
        alert('🚨 조회 정보가 누락되었습니다. 메인 페이지로 돌아갑니다.');
        window.location.href = '/';
        throw new Error('조회 정보 누락');
    }

    fetch(`/get-story?lookup_name=${encodeURIComponent(lookupName)}&lookup_pw=${encodeURIComponent(lookupPw)}`) 
        .then(response => {
            if (!response.ok) {
                // 서버에서 404/500 응답 시 에러 메시지를 표시
                return response.json().then(data => { throw new Error(data.error || '알 수 없는 오류'); });
            }
            return response.json();
        })
        .then(data => {
            // ID를 hidden 필드에 설정
            document.getElementById('story_id_hidden').value = data.STORY_ID;

            // 나이 (TEXT INPUT) 채우기
            document.getElementById('story_name').value = data.STORY_NAME || '';
            document.getElementById('story_age').value = data.STORY_AGE || '';
            
            // 성별 (RADIO BUTTONS) 채우기
            const genderValue = data.STORY_GENDER || '';
            
            if (genderValue === '남성') {
                radioMale.checked = true;
            } else if (genderValue === '여성') {
                radioFemale.checked = true;
            } else {
                // '기타'이거나 서버에 저장된 직접 입력된 값인 경우
                radioOther.checked = true;
                
                // 저장된 값이 '남성', '여성'이 아니면 기타 필드에 값을 넣음
                if (genderValue && genderValue !== '기타') { 
                    genderOtherInput.value = genderValue; 
                } else {
                     genderOtherInput.value = ''; 
                }
            }
            
            document.getElementById('story_content').value = data.STORY_CONTENT || '';

            // 경품 응모 정보 필드 채우기 (유지)
            const isGiftApplied = data.GIFT_APPLY === 'Y';
            giftApplyCheckbox.checked = isGiftApplied;

            if (isGiftApplied) {
                document.getElementById('applicant_name').value = data.APPLICANT_NAME || '';
                document.getElementById('applicant_email').value = data.APPLICANT_EMAIL || '';
                document.getElementById('applicant_phone').value = data.APPLICANT_PHONE || '';
                document.getElementById('applicant_postal').value = data.APPLICANT_POSTAL || '';
                document.getElementById('address_detail').value = data.ADDRESS_DETAIL || '';
                document.getElementById('privacy_agree').checked = data.PRIVACY_AGREE === 'Y';
            }
            
            // 초기 상태 반영 및 이벤트 리스너 설정
            toggleGenderOtherInput(); 
            genderRadios.forEach(radio => {
                radio.addEventListener('change', toggleGenderOtherInput);
            });
            togglePrizeInfoSection(); 
            giftApplyCheckbox.addEventListener('change', togglePrizeInfoSection);
            
        })
        .catch(error => {
            console.error("데이터 로드 중 에러 발생:", error);
            alert(`🚨 데이터 로드에 실패했습니다. (메시지: ${error.message})`);
            window.location.href = '/'; 
        });

    // 4. 폼 제출 시 비동기 제출 로직
    const updateForm = document.getElementById('story_update_form'); 
    const passwordUpdateField = document.getElementById('story_pw'); 
    
    updateForm.addEventListener('submit', async function (event) {
        event.preventDefault(); 

        // 비밀번호 유효성 검사 
        if (passwordUpdateField.value) {
            const hasUpperCase = /[A-Z]+/g;
            const hasLowerCase = /[a-z]+/g;
            const hasSpecialChar = /[!@#$%^&*]+/g;

            if (passwordUpdateField.value.length < 4 || !hasUpperCase.test(passwordUpdateField.value) || !hasLowerCase.test(passwordUpdateField.value) || !hasSpecialChar.test(passwordUpdateField.value)) {
                alert('비밀번호 변경 시 규칙을 만족해야 합니다.\n(4자리 이상, 대문자, 소문자, 특수문자(!@#$%^&*) 포함)');
                return;
            }
        }
        
        const formData = new FormData(updateForm);
        const data = Object.fromEntries(formData);
        
        // 서버에 보낼 데이터의 성별 필드 정리: '기타'를 선택했으면 story_gender_other의 값을 사용
        if (data.story_gender === '기타' && data.story_gender_other) {
             data.story_gender = data.story_gender_other; 
        }
        
        try {
            const response = await fetch('/update-story', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(data) 
            });

            if (response.ok) {
                alert('✅ 정상적으로 수정되었습니다!');
                window.location.href = '/'; 
            } else {
                const errorData = await response.json();
                alert(`🚨 사연 수정 실패: ${errorData.error || '알 수 없는 서버 오류'}`);
            }
        } catch (error) {
            console.error('수정 중 통신 오류:', error);
            alert('🚨 수정 요청 중 네트워크 오류가 발생했습니다. 서버 상태를 확인하세요.');
        }
    });
</script>

</html>