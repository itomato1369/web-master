<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 사연 조회 및 수정</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 라디오 버튼 그룹 레이아웃을 위한 기본 스타일 추가 */
        .radio-group label {
            margin-right: 15px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>사연 조회 및 수정</h1>
            <p class="subtitle">이전에 제출하신 사연 내용을 확인하고 수정할 수 있습니다.</p>
        </header>

        <div class="info-alert">
            <p>
                ✅ 조회된 정보가 아래 필드에 미리 채워져 있습니다.<br>
                **수정할 내용이 없으시면** 따로 제출하지 않고 **페이지를 닫거나** 돌아가셔도 **괜찮습니다.**
            </p>
        </div>

        <form action="/update-story" method="post" class="story-form" id="story_update_form">

            <input type="hidden" name="story_id" id="story_id_hidden" value="[조회된 사연 ID]">

            <section class="section essential-info">
                <h2>사연 응모자 정보 (수정)</h2>
                <div class="form-group">
                    <label for="story_name">이름/닉네임</label>
                    <input type="text" id="story_name" name="story_name" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="story_age">나이</label>
                    <input type="text" id="story_age" name="story_age" required placeholder="나이를 입력하세요.">
                </div>
                
                <div class="form-group">
                    <label>성별</label>
                    <div class="radio-group">
                        <input type="radio" id="gender_male" name="story_gender" value="남성" required>
                        <label for="gender_male">남성</label>
                        
                        <input type="radio" id="gender_female" name="story_gender" value="여성">
                        <label for="gender_female">여성</label>
                        
                        <input type="radio" id="gender_other_radio" name="story_gender" value="기타">
                        <label for="gender_other_radio">직접입력</label>
                    </div>
                    <input type="text" id="story_gender_other" name="story_gender_other" style="display:none; margin-top: 10px;" placeholder="직접 입력">
                </div>
            </section>
            
            <section class="section story-content-area">
                <h2>사연 내용 (수정)</h2>
                <div class="form-group">
                    <label for="story_content">*사연을 수정해 주세요*</label>
                    <textarea id="story_content" name="story_content" rows="10" required placeholder="당신의 이야기를 들려주세요."></textarea>
                </div>

                <div class="form-group">
                    <label for="story_pw">새 사연 비밀번호</label>
                    <input type="password" id="story_pw" name="story_pw" placeholder="변경할 경우에만 입력 (4자리 이상, 대/소문자, 특수문자 포함)">
                    <p class="guide-text">※ 비밀번호를 변경하지 않으려면 이 필드를 비워두세요. (기존 비밀번호 유지)</p>
                </div>
            </section>

            <section class="section prize-info-area">
                <h2>경품 응모 정보 (수정)</h2>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="gift_apply" name="gift_apply" value="Y">
                    <label for="gift_apply">경품 응모에 참여합니다</label>
                </div>
                
                <div id="prize_info_fields" style="display: none;">
                    <div class="form-group">
                        <label for="applicant_name">경품 수령인 이름(주민등록상 이름)</label>
                        <input type="text" id="applicant_name" name="applicant_name" placeholder="본명">
                    </div>
                    <div class="form-group">
                        <label for="applicant_email">이메일</label>
                        <input type="email" id="applicant_email" name="applicant_email" placeholder="사연 확인용 이메일">
                    </div>
                    <div class="form-group">
                        <label for="applicant_phone">연락처</label>
                        <input type="tel" id="applicant_phone" name="applicant_phone" placeholder="010-XXXX-XXXX">
                    </div>
                    
                    <div class="form-group">
                        <label for="applicant_postal">경품 수령할 주소/우편번호</label>
                        <div class="address-group">
                            <input type="text" id="applicant_postal" name="applicant_postal" placeholder="00000" maxlength="5">
                            <button type="button" class="search-button common-action-button">주소 검색</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address_detail">상세 주소</label>
                        <input type="text" id="address_detail" name="address_detail" placeholder="아파트 동/호수, 건물 이름 등">
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="privacy_agree" name="privacy_agree" value="Y">
                        <label for="privacy_agree">경품 발송을 위한 개인정보 수집 및 이용에 동의합니다</label>
                    </div>
                </div>
            </section>

            <div class="submit-area">
                <button type="submit" class="submit-button">사연 수정하기</button>
            </div>
        </form>
    </div>
</body>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const giftApplyCheckbox = document.getElementById('gift_apply');
    const prizeInfoSection = document.getElementById('prize_info_fields');
    
    // 💡 복구된 성별-기타 관련 DOM 요소 (Radio 기반)
    const genderRadios = document.querySelectorAll('input[name="story_gender"]');
    const genderOtherInput = document.getElementById('story_gender_other');
    const radioMale = document.getElementById('gender_male');
    const radioFemale = document.getElementById('gender_female');
    const radioOther = document.getElementById('gender_other_radio');


    // 1. 성별-기타 입력 필드 토글 로직 (Radio 기반)
    function toggleGenderOtherInput() {
        const selectedGender = document.querySelector('input[name="story_gender"]:checked')?.value;
        if (selectedGender === '기타') {
            genderOtherInput.style.display = 'block';
            genderOtherInput.setAttribute('required', 'required');
        } else {
            genderOtherInput.style.display = 'none';
            genderOtherInput.removeAttribute('required');
        }
    }

    // 2. 경품 정보 섹션 토글 함수 (유지)
    function togglePrizeInfoSection() {
        const isChecked = giftApplyCheckbox.checked;
        prizeInfoSection.style.display = isChecked ? 'block' : 'none';
        
        const requiredFields = prizeInfoSection.querySelectorAll(
            '#applicant_name, #applicant_email, #applicant_phone, #applicant_postal, #address_detail, #privacy_agree'
        );
        
        requiredFields.forEach(field => {
            if (isChecked) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else if (field.value) {
                    field.value = '';
                }
            }
        });
    }

    // 3. 서버에서 사연 데이터를 가져와 필드에 채우기 (로직 수정)
    const lookupName = urlParams.get('lookup_name');
    const lookupPw = urlParams.get('lookup_pw'); 
    
    if (!lookupName || !lookupPw) {
        alert('🚨 조회 정보가 누락되었습니다. 메인 페이지로 돌아갑니다.');
        window.location.href = '/';
        throw new Error('조회 정보 누락');
    }

    fetch(`/get-story?lookup_name=${encodeURIComponent(lookupName)}&lookup_pw=${encodeURIComponent(lookupPw)}`) 
        .then(response => {
            if (!response.ok) {
                // 서버에서 404/500 응답 시 에러 메시지를 표시
                return response.json().then(data => { throw new Error(data.error || '알 수 없는 오류'); });
            }
            return response.json();
        })
        .then(data => {
            // ID를 hidden 필드에 설정
            document.getElementById('story_id_hidden').value = data.STORY_ID;

            // 💡 나이 (TEXT INPUT) 채우기
            document.getElementById('story_name').value = data.STORY_NAME || '';
            document.getElementById('story_age').value = data.STORY_AGE || '';
            
            // 💡 성별 (RADIO BUTTONS) 채우기
            const genderValue = data.STORY_GENDER || '';
            
            if (genderValue === '남성') {
                radioMale.checked = true;
            } else if (genderValue === '여성') {
                radioFemale.checked = true;
            } else {
                // '기타'이거나 서버에 저장된 직접 입력된 값인 경우
                radioOther.checked = true;
                
                // 저장된 값이 '남성', '여성'이 아니면 기타 필드에 값을 넣음
                if (genderValue && genderValue !== '기타') { 
                    genderOtherInput.value = genderValue; 
                } else {
                     genderOtherInput.value = ''; 
                }
            }
            
            document.getElementById('story_content').value = data.STORY_CONTENT || '';

            // 경품 응모 정보 필드 채우기 (유지)
            const isGiftApplied = data.GIFT_APPLY === 'Y';
            giftApplyCheckbox.checked = isGiftApplied;

            if (isGiftApplied) {
                document.getElementById('applicant_name').value = data.APPLICANT_NAME || '';
                document.getElementById('applicant_email').value = data.APPLICANT_EMAIL || '';
                document.getElementById('applicant_phone').value = data.APPLICANT_PHONE || '';
                document.getElementById('applicant_postal').value = data.APPLICANT_POSTAL || '';
                document.getElementById('address_detail').value = data.ADDRESS_DETAIL || '';
                document.getElementById('privacy_agree').checked = data.PRIVACY_AGREE === 'Y';
            }
            
            // 초기 상태 반영 및 이벤트 리스너 설정
            toggleGenderOtherInput(); 
            genderRadios.forEach(radio => {
                radio.addEventListener('change', toggleGenderOtherInput);
            });
            togglePrizeInfoSection(); 
            giftApplyCheckbox.addEventListener('change', togglePrizeInfoSection);
            
        })
        .catch(error => {
            console.error("데이터 로드 중 에러 발생:", error);
            alert(`🚨 데이터 로드에 실패했습니다. (메시지: ${error.message})`);
            window.location.href = '/'; 
        });

    // 4. 폼 제출 시 비동기 제출 로직 (유지)
    const updateForm = document.getElementById('story_update_form'); 
    const passwordUpdateField = document.getElementById('story_pw'); 
    
    updateForm.addEventListener('submit', async function (event) {
        event.preventDefault(); 

        // 비밀번호 유효성 검사 (유지)
        if (passwordUpdateField.value) {
            const hasUpperCase = /[A-Z]+/g;
            const hasLowerCase = /[a-z]+/g;
            const hasSpecialChar = /[!@#$%^&*]+/g;

            if (passwordUpdateField.value.length < 4 || !hasUpperCase.test(passwordUpdateField.value) || !hasLowerCase.test(passwordUpdateField.value) || !hasSpecialChar.test(passwordUpdateField.value)) {
                alert('비밀번호 변경 시 규칙을 만족해야 합니다.\n(4자리 이상, 대문자, 소문자, 특수문자(!@#$%^&*) 포함)');
                return;
            }
        }
        
        const formData = new FormData(updateForm);
        const data = Object.fromEntries(formData);
        
        // 서버에 보낼 데이터의 성별 필드 정리: '기타'를 선택했으면 story_gender_other의 값을 사용 (유지)
        if (data.story_gender === '기타' && data.story_gender_other) {
             data.story_gender = data.story_gender_other; 
        }
        
        try {
            const response = await fetch('/update-story', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(data) 
            });

            if (response.ok) {
                alert('✅ 정상적으로 수정되었습니다!');
                window.location.href = '/'; 
            } else {
                const errorData = await response.json();
                alert(`🚨 사연 수정 실패: ${errorData.error || '알 수 없는 서버 오류'}`);
            }
        } catch (error) {
            console.error('수정 중 통신 오류:', error);
            alert('🚨 수정 요청 중 네트워크 오류가 발생했습니다. 서버 상태를 확인하세요.');
        }
    });
</script>

</html>